#cloud-config
groups:
    - salt


users:
    - name: salt
      primary_group: salt
      shell: /usr/sbin/nologin
      homedir: /opt/saltstack/salt


write_files:
    - path: /etc/salt/minion.d/saltshaker.conf
      content: |
          master: ${saltmaster_ip}
%{ if additional_ipv4 != false ~}
    - path: /etc/network/interfaces.d/60-floating-ip.cfg
      permissions: '0644'
      content: |
          auto eth0:1
          iface eth0:1 inet static
              address ${additional_ipv4}
              netmask 32
%{ endif ~}


runcmd:
%{ if additional_ipv4 != false ~}
    - ifup eth0:1
%{ endif ~}
%{ if ipv6_only ~}
    - ip route del default || /usr/bin/true
    - ip route add default via 10.0.0.1
    - echo "nameserver 8.8.8.8" >> /etc/resolv.conf
    - echo "Waiting for NAT to come up..."
    - /usr/bin/bash -c 'until dig +tries=1 +retry=0 debian.org > /dev/null; do sleep 1; echo -n "."; done; echo "";'
%{ endif ~}
    - mkdir -p /etc/apt/keyrings
    - apt update
    - apt -y install --no-install-recommends gnupg
    - wget -O /etc/apt/keyrings/salt-archive-keyring-2023.gpg.tmp https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public
    - gpg --dearmor -o /etc/apt/keyrings/salt-archive-keyring-2023.gpg /etc/apt/keyrings/salt-archive-keyring-2023.gpg.tmp
    - rm /etc/apt/keyrings/salt-archive-keyring-2023.gpg.tmp
    - /usr/bin/bash -c 'echo deb [signed-by=/etc/apt/keyrings/salt-archive-keyring-2023.gpg arch=amd64] https://packages.broadcom.com/artifactory/saltproject-deb/ stable main > /etc/apt/sources.list.d/salt.list'
    - apt update
    - mkdir -p /etc/salt/roles.d
    - mkdir -p /etc/salt/env.d
    ${indent(4, yamlencode([for r in roles: "touch /etc/salt/roles.d/${r}"]))}
%{ if ipv6_only ~}
    - echo true > /etc/salt/env.d/ipv6_only
%{ endif ~}
    - echo ${server_type} > /etc/salt/env.d/server_type
    - apt install -y --no-install-recommends git salt-minion
    - chown -R salt:salt /etc/salt
    - systemctl restart salt-minion


final_message: |
    Next steps:
        Add the minion key on saltmaster. Execute highstate:
            salt-key -y -a ${hostname}
            salt '${hostname}' state.highstate
